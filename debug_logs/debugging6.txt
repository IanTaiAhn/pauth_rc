INFO:     127.0.0.1:62253 - "GET /api/list_indexes HTTP/1.1" 200 OK
INDEX PATHS DIR :  C:\Users\n0308g\Git_Repos\pauth_rc\backend\app\rag_pipeline\vectorstore
os from embedder.py:  C:\Users\n0308g\Git_Repos\pauth_rc
INFO:sentence_transformers.SentenceTransformer:Use pytorch device_name: cpu
INFO:sentence_transformers.SentenceTransformer:Load pretrained SentenceTransformer: backend/app/rag_pipeline/models/minilm
WARNING:sentence_transformers.SentenceTransformer:No sentence-transformers model found with name backend/app/rag_pipeline/models/minilm. Creating a new one with mean pooling.
current index build_index:  mocked_insurance_policy
Loaded index build_index: mocked_insurance_policy

================================================================================
Query: Aetna CPT 73721 coverage criteria clinical findings conservative treatment imaging requirements
================================================================================

Retrieved 6 chunks:

1. AETNA CLINICAL POLICY BULLETIN
   Rule Type: general
   Original Score: 0.5587
   Boost Factor: 2.00x
   Boosted Score: 1.1175
   Boost Reasons: exact_code_match

2. PRIOR IMAGING:
   Rule Type: prior_imaging
   Original Score: 0.4916
   Boost Factor: 1.30x
   Boosted Score: 0.6391
   Boost Reasons: rule_type_match

3. AETNA SUPPLEMENTARY GUIDELINES
   Rule Type: general
   Original Score: 0.5693
   Boost Factor: 1.00x
   Boosted Score: 0.5693

4. IMAGING REQUIREMENT:
   Rule Type: imaging_requirement
   Original Score: 0.3149
   Boost Factor: 1.69x
   Boosted Score: 0.5323
   Boost Reasons: requirement_match, rule_type_match

5. DIAGNOSIS REQUIREMENT:
   Rule Type: diagnosis_requirement
   Original Score: 0.2898
   Boost Factor: 1.30x
   Boosted Score: 0.3768
   Boost Reasons: requirement_match

6. AUTHORIZATION OUTCOMES:
   Rule Type: general
   Original Score: 0.3638
   Boost Factor: 1.00x
   Boosted Score: 0.3638

âœ“ Retrieved 6 candidate chunks

DEBUG TYPE CHECK:
Type of context: <class 'list'>
First element type: <class 'dict'>
Preview: [{'doc_name': 'C:\\Users\\n0308g\\Git_Repos\\pauth_rc\\backend\\uploaded_docs\\mocked_insurance_policy.txt', 'chunk_id': 'general_main', 'text': 'AETNA CLINICAL POLICY BULLETIN\nMagnetic Resonance Imaging (MRI) - Musculoskeletal\nPolicy Number: 0567\nLast Review Date: December 1, 2024\nEffective Date: January 1, 2025================================================================================\nSECTION 1: POLICY STATEMENTAetna considers magnetic resonance imaging (MRI) of the extremities medically\nnecessary when clinical criteria are met and conservative management has been\nattempted where appropriate.================================================================================\nSECTION 2: KNEE MRI - PRIOR AUTHORIZATION REQUIREMENTSCPT Codes: 73721, 73722, 73723COVERAGE CRITERIA:MRI of the knee is considered MEDICALLY NECESSARY when ALL of the following\ncriteria are met:', 'rule_type': 'general', 'section_header': 'AETNA CLINICAL POLICY BULLETIN', 'parent_context': None, 'logical_operator': 'ALL', 'is_exception': False, 'is_requirement': False, 'is_definition': False, 'cpt_codes': ['73721', '73722'], 'icd_codes': [], 'boost_factor': 2.0, 'boost_reasons': ['exact_code_match'], 'original_score': 0.5587307214736938, 'boosted_score': 1.1174614429473877}, {'doc_name': 'C:\\Users\\n0308g\\Git_Repos\\pauth_rc\\backend\\uploaded_docs\\mocked_insurance_policy.txt', 'chunk_id': 'prior_imaging_main', 'text': "PRIOR IMAGING:\nIf member has had knee MRI within past 12 months, new imaging requires\ndocumentation of: (a) change in clinical status, (b) failed intervention,\nor (c) pre-operative planning\nSECTION 3: NOT MEDICALLY NECESSARYMRI of the knee is considered NOT MEDICALLY NECESSARY for:\nRoutine screening without symptoms\nIsolated anterior knee pain without mechanical symptoms or instability\nMild osteoarthritis with no surgical planning\nWorker's compensation cases without orthopedic evaluation\nMember declines surgical intervention regardless of findings\nSECTION 4: DOCUMENTATION REQUIREMENTSThe following must be submitted with prior authorization request:\nRecent clinical notes (within 30 days) documenting:\nHistory and physical examination\nSpecific clinical findings (exam maneuvers, ROM, effusion)\nDuration and character of symptoms\nConservative treatment records:\nPhysical therapy notes with dates and number of sessions\nMedication trial documentation\nX-ray report (within 60 days)\nClear statement of medical necessity and treatment plan impact\nSECTION 5: AUTHORIZATION VALIDITY\nApproved authorizations valid for 60 days from approval date\nMember must complete imaging within validity period\nRe-authorization required if imaging not completed within 60 days\nAPPENDIX A: RELATED CPT CODES73721 - MRI lower extremity without contrast\n73722 - MRI lower extremity with contrast\n73723 - MRI lower extremity without contrast, followed by with contrastFor questions: Aetna Prior Authorization Department\nPhone: 1-800-123-4567\nOnline: www.aetna.com/precertification", 'rule_type': 'prior_imaging', 'section_header': 'PRIOR IMAGING:', 'parent_context': None, 'logical_operator': None, 'is_exception': False, 'is_requirement': False, 'is_definition': False, 'cpt_codes': ['73722', '73723'], 'icd_codes': [], 'boost_factor': 1.3, 'boost_reasons': ['rule_type_match'], 'original_score': 0.49162358045578003, 'boosted_score': 0.639110654592514}, {'doc_name': 'C:\\Users\\n0308g\\Git_Repos\\pauth_rc\\backend\\uploaded_docs\\mocked_payer_guidelines.txt', 'chunk_id': 'general_main', 'text': 'AETNA SUPPLEMENTARY GUIDELINES\nKnee MRI Clinical Decision Support\nDocument ID: RAD-KNEE-2024-SUPP\nVersion: 2.1', 'rule_type': 'general', 'section_header': 'AETNA SUPPLEMENTARY GUIDELINES', 'parent_context': None, 'logical_operator': None, 'is_exception': False, 'is_requirement': False, 'is_definition': False, 'cpt_codes': [], 'icd_codes': [], 'boost_factor': 1.0, 'boost_reasons': [], 'original_score': 0.5693300366401672, 'boosted_score': 0.5693300366401672}, {'doc_name': 'C:\\Users\\n0308g\\Git_Repos\\pauth_rc\\backend\\uploaded_docs\\mocked_insurance_policy.txt', 'chunk_id': 'imaging_requirement_main', 'text': 'IMAGING REQUIREMENT:\nWeight-bearing X-rays of the affected knee must be completed within\nthe past 60 days prior to MRI request\nX-ray report must be available for review', 'rule_type': 'imaging_requirement', 'section_header': 'IMAGING REQUIREMENT:', 'parent_context': None, 'logical_operator': None, 'is_exception': False, 'is_requirement': True, 'is_definition': False, 'cpt_codes': [], 'icd_codes': [], 'boost_factor': 1.6900000000000002, 'boost_reasons': ['requirement_match', 'rule_type_match'], 'original_score': 0.3149493932723999, 'boosted_score': 0.5322644746303559}, {'doc_name': 'C:\\Users\\n0308g\\Git_Repos\\pauth_rc\\backend\\uploaded_docs\\mocked_insurance_policy.txt', 'chunk_id': 'diagnosis_requirement_main', 'text': 'DIAGNOSIS REQUIREMENT:\nMember must have a documented diagnosis consistent with one of the following:\nSuspected meniscal tear (ICD-10: M23.2xx, M23.3xx)\nSuspected ligamentous injury (ICD-10: S83.5xx, S83.6xx)\nKnee pain with mechanical symptoms (ICD-10: M25.56x)\nOsteoarthritis requiring pre-surgical evaluation (ICD-10: M17.xx)\nSuspected osteochondral lesion (ICD-10: M93.2xx)', 'rule_type': 'diagnosis_requirement', 'section_header': 'DIAGNOSIS REQUIREMENT:', 'parent_context': None, 'logical_operator': None, 'is_exception': False, 'is_requirement': True, 'is_definition': False, 'cpt_codes': [], 'icd_codes': ['M23.2xx', 'M23.3xx', 'S83.5xx', 'S83.6xx', 'M25.56x', 'M17.xx', 'M93.2xx'], 'boost_factor': 1.3, 'boost_reasons': ['requirement_match'], 'original_score': 0.28981003165245056, 'boosted_score': 0.37675304114818575}, {'doc_name': 'C:\\Users\\n0308g\\Git_Repos\\pauth_rc\\backend\\uploaded_docs\\mocked_payer_guidelines.txt', 'chunk_id': 'general_main', 'text': 'AUTHORIZATION OUTCOMES:\nAPPROVED: All criteria clearly met\nPENDED: Missing documentation, request additional records within 5 business days\nDENIED: Criteria not met, specific deficiencies listed in denial letter\nPEER-TO-PEER: Complex case, offer physician reviewer discussion', 'rule_type': 'general', 'section_header': 'AUTHORIZATION OUTCOMES:', 'parent_context': None, 'logical_operator': None, 'is_exception': False, 'is_requirement': False, 'is_definition': False, 'cpt_codes': [], 'icd_codes': [], 'boost_factor': 1.0, 'boost_reasons': [], 'original_score': 0.36384597420692444, 'boosted_score': 0.36384597420692444}]
INFO:sentence_transformers.cross_encoder.CrossEncoder:Use pytorch device: cpu

================================================================================
RERANKING: 6 candidates
Query: Aetna CPT 73721 coverage criteria clinical findings conservative treatment imaging requirements
Intent: {'seeks_exception': False, 'seeks_requirement': True, 'seeks_definition': False, 'mentions_codes': True, 'mentions_age': True, 'seeks_comprehensive': False}
Codes: CPT=['73721'], ICD=[]
================================================================================

Batches: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00<00:00,  2.50it/s] 

Top candidates after reranking:

1. Score: 7.5835
   Section: AETNA CLINICAL POLICY BULLETIN
   Rule Type: general
   Breakdown:
      Base: 4.3578
      Type: 0.70x
      Keywords: 1.13x
      Metadata: 2.20x
   Boost Reasons: exact_cpt_match, has_logical_operator

2. Score: 5.2304
   Section: PRIOR IMAGING:
   Rule Type: prior_imaging
   Breakdown:
      Base: 3.8346
      Type: 1.10x
      Keywords: 1.24x
      Metadata: 1.00x

3. Score: -3.2596
   Section: AETNA SUPPLEMENTARY GUIDELINES
   Rule Type: general
   Breakdown:
      Base: -4.6566
      Type: 0.70x
      Keywords: 1.00x
      Metadata: 1.00x

âœ“ Reranked to top 3 chunks

ðŸ“š TOP RERANKED CHUNKS SENT TO LLM:

âœ“ Built medical policy extraction prompt

ðŸ§  FINAL PROMPT SENT TO MODEL:

You are a medical policy analyst extracting coverage criteria from insurance documents.

CONTEXT DOCUMENTS:
Source 1 (Doc: C:\Users\n0308g\Git_Repos\pauth_rc\backend\uploaded_docs\mocked_insurance_policy.txt | ID: general_main):
AETNA CLINICAL POLICY BULLETIN
Magnetic Resonance Imaging (MRI) - Musculoskeletal
Policy Number: 0567
Last Review Date: December 1, 2024
Effective Date: January 1, 2025================================================================================
SECTION 1: POLICY STATEMENTAetna considers magnetic resonance imaging (MRI) of the extremities medically
necessary when clinical criteria are met and conservative management has been
attempted where appropriate.================================================================================
SECTION 2: KNEE MRI - PRIOR AUTHORIZATION REQUIREMENTSCPT Codes: 73721, 73722, 73723COVERAGE CRITERIA:MRI of the knee is considered MEDICALLY NECESSARY when ALL of the following
criteria are met:

Source 2 (Doc: C:\Users\n0308g\Git_Repos\pauth_rc\backend\uploaded_docs\mocked_insurance_policy.txt | ID: prior_imaging_main):
PRIOR IMAGING:
If member has had knee MRI within past 12 months, new imaging requires
documentation of: (a) change in clinical status, (b) failed intervention,
or (c) pre-operative planning
SECTION 3: NOT MEDICALLY NECESSARYMRI of the knee is considered NOT MEDICALLY NECESSARY for:
Routine screening without symptoms
Isolated anterior knee pain without mechanical symptoms or instability
Mild osteoarthritis with no surgical planning
Worker's compensation cases without orthopedic evaluation
Member declines surgical intervention regardless of findings
SECTION 4: DOCUMENTATION REQUIREMENTSThe following must be submitted with prior authorization request:
Recent clinical notes (within 30 days) documenting:
History and physical examination
Specific clinical findings (exam maneuvers, ROM, effusion)
Duration and character of symptoms
Conservative treatment records:
Physical therapy notes with dates and number of sessions
Medication trial documentation
X-ray report (within 60 days)
Clear statement of medical necessity and treatment plan impact
SECTION 5: AUTHORIZATION VALIDITY
Approved authorizations valid for 60 days from approval date
Member must complete imaging within validity period
Re-authorization required if imaging not completed within 60 days
APPENDIX A: RELATED CPT CODES73721 - MRI lower extremity without contrast
73722 - MRI lower extremity with contrast
73723 - MRI lower extremity without contrast, followed by with contrastFor questions: Aetna Prior Authorization Department
Phone: 1-800-123-4567
Online: www.aetna.com/precertification

Source 3 (Doc: C:\Users\n0308g\Git_Repos\pauth_rc\backend\uploaded_docs\mocked_payer_guidelines.txt | ID: general_main):
AETNA SUPPLEMENTARY GUIDELINES
Knee MRI Clinical Decision Support
Document ID: RAD-KNEE-2024-SUPP
Version: 2.1

TASK:
Extract the medical necessity criteria for Aetna's coverage of CPT code 73721.

OUTPUT FORMAT (JSON only, no additional text):
{
  "payer": "Aetna",
  "cpt_code": "73721",
  "coverage_criteria": {
    "clinical_indications": ["list of approved diagnoses/conditions"],
    "prerequisites": ["required prior treatments or tests"],
    "exclusion_criteria": ["conditions where NOT covered"],
    "documentation_requirements": ["required medical documentation"],
    "quantity_limits": {"description": "frequency/quantity limits if any"}
  },
  "source_references": ["document IDs used"]
}